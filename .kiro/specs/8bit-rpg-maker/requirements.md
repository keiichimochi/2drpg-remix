# Requirements Document

## Introduction

8ビット風2D RPGゲームツクールをWebブラウザ上で動作させるツールを開発します。Remix、React、PixiJSを使用して、直感的なマップエディタ、イベントシステム、プレビュー機能を提供し、ゲーム制作者が簡単にRPGを作成できる環境を構築します。

## Requirements

### Requirement 1: プロジェクト管理

**User Story:** ゲーム制作者として、新しいRPGプロジェクトを作成・管理できるようにしたい。そうすることで、複数のゲームプロジェクトを整理して開発できる。

#### Acceptance Criteria

1. WHEN ユーザーが「新規プロジェクト」を実行 THEN システムは初期プロジェクト（設定・空マップ・デフォルトアセット構造）を生成する
2. WHEN プロジェクトが作成される THEN システムはmaps/, tilesets/, sprites/, events/, project.jsonの構造を生成する
3. WHEN プロジェクトが作成される THEN システムは自動保存を実行しトースト表示する

### Requirement 2: マップエディタ

**User Story:** ゲーム制作者として、16×16ピクセル基準のタイルを使ってマップを編集したい。そうすることで、ゲームの世界を視覚的に構築できる。

#### Acceptance Criteria

1. WHEN ユーザーがマップ編集画面を開く THEN システムはグリッド表示ON/OFF、ズーム0.5×〜8×を提供する
2. WHEN ユーザーがレイヤーを操作する THEN システムは地形/衝突/装飾の最低3種のレイヤー切替・追加・順序変更を提供する
3. WHEN 64×64以上のマップを編集する THEN システムは一般的PCで60FPSでパン・描画を維持する

### Requirement 3: タイルセット管理

**User Story:** ゲーム制作者として、PNGタイルシートをアップロードして自動的にタイルパレットを生成したい。そうすることで、効率的にタイル素材を管理できる。

#### Acceptance Criteria

1. WHEN ユーザーがPNGタイルシートをアップロード THEN システムは自動的に16×16でスライスし、透過色対応で最大4096タイルのタイルパレットを生成する
2. WHEN タイルが再インポートされる THEN システムは安定ID（再インポートで維持）を保持する

### Requirement 4: スプライト・アニメーション管理

**User Story:** ゲーム制作者として、キャラクターのスプライトとアニメーションを定義したい。そうすることで、動きのあるキャラクターを作成できる。

#### Acceptance Criteria

1. WHEN ユーザーがスプライトPNGとアニメ定義を登録 THEN システムは左右上下の歩行アニメ（各3フレーム以上）を定義できる
2. WHEN アニメーションを設定する THEN システムは1スプライトにつき複数アニメ、FPS調整を可能にする

### Requirement 5: 衝突と領域管理

**User Story:** ゲーム制作者として、マップ上の衝突判定や特殊領域を設定したい。そうすることで、ゲームプレイに必要な制約や効果を実装できる。

#### Acceptance Criteria

1. WHEN ユーザーが衝突レイヤーを編集 THEN システムは衝突の可視化トグルを提供する
2. WHEN ユーザーが領域を設定する THEN システムはタイル単位or矩形での衝突/通行可設定と領域タグ（草むら=encounter、毒沼=damage等）を設定できる

### Requirement 6: イベント・スクリプトシステム

**User Story:** ゲーム制作者として、ノード式エディタでゲームイベントを作成したい。そうすることで、プログラミング知識なしでもゲームロジックを実装できる。

#### Acceptance Criteria

1. WHEN ユーザーがイベントノードエディタを開く THEN システムはTalk, IfFlag, SetFlag, Warp, GiveItem, StartBattle(ダミー)の必須ノードを提供する
2. WHEN イベントを作成する THEN システムはノードをJSONに保存・読み込み可能にする
3. WHEN イベントを配置する THEN システムはイベントをマップ上の座標に紐付けできる

### Requirement 7: ダイアログ・ローカライズ

**User Story:** ゲーム制作者として、多言語対応のダイアログシステムを使いたい。そうすることで、国際的にゲームを展開できる。

#### Acceptance Criteria

1. WHEN ユーザーが台詞を編集 THEN システムは既定言語=ja、追加言語を任意追加できる多言語キー管理を提供する
2. WHEN ダイアログをプレビューする THEN システムは変数埋め込み {playerName} がプレビューに反映される

### Requirement 8: プレビュー機能

**User Story:** ゲーム制作者として、作成中のゲームを同一画面内でテストプレイしたい。そうすることで、開発中に動作確認ができる。

#### Acceptance Criteria

1. WHEN ユーザーがプレビューを起動 THEN システムは矢印/WASD・スペースで決定の操作で衝突・イベント起動・マップ遷移を動作させる
2. WHEN プレビューを実行する THEN システムは30/60FPS切替を提供する
3. WHEN ゲームを表示する THEN システムは8ビット風スケーリング（ニアレストネイバー）を適用する

### Requirement 9: プロジェクト保存・ロード

**User Story:** ゲーム制作者として、作業内容が自動的に保存され、必要に応じて手動保存や履歴管理ができるようにしたい。そうすることで、作業の安全性と効率性を確保できる。

#### Acceptance Criteria

1. WHEN 変更が発生 THEN システムは5秒ごとに自動保存し、競合時は最新版を優先し差分リスト表示する
2. WHEN ユーザーが操作する THEN システムはUndo/Redo 最低50ステップを提供する

### Requirement 10: インポート・エクスポート

**User Story:** ゲーム制作者として、プロジェクトをエクスポート・インポートできるようにしたい。そうすることで、プロジェクトの共有やバックアップができる。

#### Acceptance Criteria

1. WHEN ユーザーがエクスポートを実行 THEN システムはJSON＋アセットZIPを生成し、エクスポートZip内構造はプロジェクト構造と整合する
2. WHEN プロジェクトをインポートする THEN システムは別環境で再インポート可能にし、別プロジェクトへインポートしてもID整合が取れる

### Requirement 11: パフォーマンス

**User Story:** ゲーム制作者として、大きなマップでも快適に編集・プレビューできるようにしたい。そうすることで、制作効率を維持できる。

#### Acceptance Criteria

1. WHEN 128×128タイル（3レイヤー）マップを編集/プレビュー THEN システムは中級GPUで安定60FPS、最低30FPSを下回らない
2. WHEN システムが動作する THEN システムはタイルカリング/バッチ描画を有効化し、メモリリーク検出（開発ビルドでウォーニング）を提供する

### Requirement 12: 拡張性

**User Story:** 開発者として、プラグインAPIを使ってツールを拡張したい。そうすることで、カスタム機能を追加できる。

#### Acceptance Criteria

1. WHEN 開発者が拡張したい THEN システムはカスタムノードの登録・ツールボックス表示を可能にする
2. WHEN プラグインAPIを提供する THEN システムはサンプルプラグイン1個を同梱する

### Requirement 13: AIマップチップ自動生成

**User Story:** ゲーム制作者として、AIを使って8ビット風のマップチップを自動生成したい。そうすることで、素材制作の時間を短縮し、創作に集中できる。

#### Acceptance Criteria

1. WHEN ユーザーが「AIでタイル生成」を実行 THEN システムはプロンプト＋スタイル設定から生成ジョブを作成し、非同期で進捗を可視化する
2. WHEN 生成ジョブが開始 THEN システムはGeminiの画像生成API（Imagen 3系またはGemini 2.xのImage Gen機能）を用いて1024px級キャンバスでタイルシート原画を生成する
3. WHEN 生成画像が取得できた THEN システムは8ビット風へ整形（パレット制限、ディザリング、16×16スライス、ニアレスト縮小）する
4. WHEN 地形系を生成 THEN システムはWangタイル/マーチングスクエア互換の接続パターンを自動推定・並べ替えする
5. WHEN 整形後 THEN システムは画像特徴＋プロンプトからtags（例：草/砂/水深/壁/床/装飾/当たり判定推奨）を自動推定する
6. WHEN ユーザーがN>1指定 THEN システムはシード制御で複数案を生成し、同シードで再現可能にする
7. WHEN 画像生成を行う THEN システムはGemini/Imagenのポリシーと安全フィルタに従い、NG時はフォールバック提案を行う
8. WHEN 管理者が設定を開く THEN システムはモデル（品質/コスト）、リージョン、同時実行上限を設定できる
9. WHEN 生成完了 THEN システムはそのままタイルパレットに並び、地形/衝突/装飾レイヤへドラッグ可能にする

### Requirement 14: 品質保証

**User Story:** 開発チームとして、継続的インテグレーションで品質を保証したい。そうすることで、安定したソフトウェアを提供できる。

#### Acceptance Criteria

1. WHEN CIが走る THEN システムは主要シナリオ（プロジェクト作成→マップ編集→プレビュー→エクスポート）E2Eテストを緑にする
2. WHEN パフォーマンスを測定する THEN システムはLCP<2.5s（編集画面初回表示、デスクトップ）を達成する